#include <math.h>
#include <stdio.h>
#include "fft4g.h"

#define MAX(x,y) ((x) > (y) ? (x) : (y))

/* random number generator, 0 <= RND < 1 */
#define RND(p) ((*(p) = (*(p) * 7141 + 54773) % 259200) * (1.0 / 259200.0))

#ifndef NMAX
#define NMAX 8192
#define NMAXSQRT 64
#endif

// #define audio_length 5888
#define audio_length 256
#define frame_size 256

const int spect_length = audio_length / frame_size; // 23
const int spect_width = frame_size / 2; // 129

double frame[256];

void stft(double audio[audio_length], double spectogram[spect_length * spect_width]);

int main()
{
    printf("\n");
    double spectogram[spect_length * spect_width];
    stft(frame, spectogram);

    int i;
    for (i = 0; i < spect_width; i++) {
        printf("%f, ", spectogram[i]);
    }
}

void stft(double audio[audio_length], double spectogram[spect_length * spect_width]) {
    int ip[NMAXSQRT + 2];
    double w[NMAX * 5 / 4];

    // n_fft == hop_length for this stft (no overlap)
    int i, j, start_i;
    double a[frame_size];
    for (i = 0; i < spect_length; i++) {
        start_i = i * 256;
        for (j = 0; j < frame_size; j++) { // copy section into array a
            a[j] = audio[start_i + j];
        }
        // printf("mark 1");
        rdft(frame_size, 1, a, ip, w);      // do fft

        for (j = 0; j < spect_width; j++) {
            spectogram[i * spect_length + j] = sqrt(pow(a[2 * j], 2) + pow(a[2 * j + 1], 2));   // magnitude of vector
        }
        spectogram[i * spect_length] = fabs(a[0]);
    }
}


double frame[256] = {-0.05595568, 0.04780372, -0.029679462, 0.031658094, -0.011555204, -0.00514444, 0.046933122, -0.026197072, 
0.04519193, -0.043055005, 0.01361298, -0.0036406806, -0.007281361, -0.006885635, -0.017570242, 0.016937079, 
0.002057776, 0.0043529877, -0.00087059755, -0.01543332, 0.011001187, -0.012821527, 0.0004748714, -0.009576573, 
0.003719826, 0.027463395, -0.015987337, 0.042738426, -0.023189552, 0.034111593, -0.015116739, 0.004036407, 
-0.012584092, -0.0029283736, 0.003086664, -0.02406015, 0.008468539, -0.022318956, 0.015908191, -0.013850415, 
0.002770083, -0.004511278, -0.008310249, 0.018440839, -0.0049070045, 0.005698457, 0.007439652, -0.005777602, 
0.009893154, -0.012504946, 0.002770083, -0.01543332, 0.016857935, -0.024772458, 0.038781162, -0.04265928, 
0.031262368, -0.022318956, 0.005777602, -0.0022952117, -0.035536207, 0.03466561, -0.038543727, 0.03703997, 
-0.009339137, 0.0056193112, 0.019074, 0.0026909378, 0.009893154, -0.003403245, 0.007202216, -0.0066481996, 
0.0026909378, -0.025168184, 0.009972299, -0.036723386, -0.012346656, 0.024297586, -0.018045112, 0.040918086, 
-0.014721013, 0.054135337, -0.012267511, -0.012821527, 0.006173328, -0.08341908, 0.043529876, -0.04685398, 
0.013533834, 0.029837752, 0.055797387, 0.08278591, 0.031578947, 0.0880095, 0.01859913, 0.025009893, 
0.031816382, -0.07130986, -0.022714682, -0.040284924, -0.028808864, -0.083577365, -0.045508508, -0.03767313, 
-0.057538584, 0.024693312, -0.09442026, 0.016066482, -0.028096557, 0.066798575, -0.031974673, 0.010684607, 
0.10114761, -0.0004748714, 0.10676692, 0.020815196, 0.02690938, 0.04867432, 0.023585279, -0.011792639, 
-0.05943807, -0.0029283736, -0.04083894, -0.07075584, -0.01875742, -0.059279777, -0.024693312, 0.005777602, 
-0.0034823902, -0.02920459, 0.021527503, 0.03521963, -0.005065295, 0.003957262, 0.023506133, 0.010684607, 
0.019153146, 0.015116739, 0.0089434115, -0.014879304, 0.0414721, -0.007202216, -0.03450732, 0.009655719, 
-0.014721013, -0.004511278, -0.028729718, 0.0112386225, -0.023664424, -0.0016620499, 0.040047485, -0.018282548, 
0.022477245, 0.011792639, 0.028729718, -0.023664424, 0.026117926, -0.012821527, -0.01677879, 0.014325287, 
-0.03696082, 0.0002374357, -0.009418283, 0.0155124655, -0.019707162, 0.037752274, -0.0017411951, -0.0018203403, 
0.017491097, 0.024455877, -0.039414324, 0.0257222, 0.011555204, -0.024772458, 0.011396914, 0.022952117, 
-0.02540562, -0.016541352, 0.051523544, -0.04400475, -0.019865453, 0.023585279, -0.0073605063, -0.027067669, 
0.018282548, 0.026117926, -0.049386624, 0.031578947, 0.007281361, -0.03403245, -0.009180847, 0.037119113, 
-0.024535023, -0.02073605, 0.04218441, -0.0063316184, -0.011792639, 0.029600317, 0.015116739, -0.029837752, 
0.047882866, 0.0017411951, -0.0053818757, -0.0012663237, 0.021131776, -0.022872971, -0.0063316184, 0.015987337, 
-0.055322517, -0.019944599, 0.01677879, -0.060625248, 0.013375544, 0.011713495, -0.019786308, 0.035298772, 
0.037910566, 0.007993668, -0.01377127, 0.06481995, -0.011159478, -0.049228333, 0.062999606, -0.056351405, 
-0.008547685, 0.024614166, -0.0049070045, -0.04748714, 0.03347843, 0.011317768, -0.05160269, 0.026117926, 
0.0009497428, -0.029442025, 0.0018203403, 0.025801346, -0.037910566, 0.014721013, 0.03870202, -0.026751088, 
0.008864266, 0.043688167, 0.010684607, -0.03347843, 0.029679462, -0.020656906, -0.010842897, -0.010842897, 
-0.007914524, -0.029600317, 0.031420656, 0.021527503, -0.039256036, 0.017807677, 0.03118322, -0.00514444};